jQuery(function($){"use strict";let a=function(d,f,g="media"){let a=jQuery(".bulk-compression-wrapper .wpf-progress-state-text");return appLocalizer.__compressed=parseInt(a.find("span:first-child").html()),appLocalizer.__total=parseInt(a.find("span:last-child").html()),appLocalizer.__errors=[],appLocalizer.__log=jQuery(".compression-final-log"),appLocalizer.__perf=0,appLocalizer.__deferred=jQuery.Deferred(),appLocalizer.__deferred.errors=[],appLocalizer.__is_bulk=!1,appLocalizer.__bulk_ajax_suffix="wp_compressit_bulk",appLocalizer.__single_ajax_suffix="wp_compressit_manual",appLocalizer.__ids=[],appLocalizer.__button=jQuery(d[0]),appLocalizer.__is_bulk=f,appLocalizer.__url=B("wp_compressit_manual"),appLocalizer.skip_recompress=!(void 0===appLocalizer.__button.data("compression")||!appLocalizer.__button.data("compression")),b(),appLocalizer.__is_bulk_recompress=0<appLocalizer.recompress.length&&!appLocalizer.skip_recompress,appLocalizer.__status=appLocalizer.__button.parent().prev(".compression-status"),appLocalizer.__compression_type=g,c(),e(),z(),t(),appLocalizer.__deferred},b=function(){let a=[];"object"==typeof(a=0<appLocalizer.recompress.length&&!appLocalizer.skip_recompress?0<appLocalizer.uncompressed.length?appLocalizer.recompress.concat(appLocalizer.uncompressed):appLocalizer.recompress:appLocalizer.uncompressed)?appLocalizer.__ids=a.filter(function(a,b,c){return b===c.indexOf(a)}):appLocalizer.__ids=a},c=function(){appLocalizer.__button.prop("disabled",!0),appLocalizer.__button.addClass("wpfiles-started"),d(),y()},d=function(){appLocalizer.__is_bulk||(appLocalizer.__button.html('<span class="spinner wpfiles-progress">'+appLocalizer.wpfiles_msgs.compressing+"</span>"),appLocalizer.__status.removeClass("error"))},e=function(){appLocalizer.__is_bulk&&appLocalizer.__ids.length>0&&f(),appLocalizer.__is_bulk||f()},f=function(){if(0!==appLocalizer.__perf&& void 0!==appLocalizer.__perf&&10>performance.now()-appLocalizer.__perf)return g(),appLocalizer.__deferred;let a="";appLocalizer.__current_id=appLocalizer.__is_bulk?appLocalizer.__ids.shift():appLocalizer.__button.data("id"),h(appLocalizer.__current_id);let b=appLocalizer.__button.parent().find("#_wpfiles_nonce");return b&&(a=b.val()),appLocalizer.__request=i(appLocalizer.__is_bulk_recompress,appLocalizer.__current_id,appLocalizer.__url,a).done(function(a){if(void 0===a.success|| void 0!==a.success&& !1===a.success&& void 0!==a.data&&"limit_exceeded"!==a.data.error){appLocalizer.__errors.push(appLocalizer.__current_id);let b=u(a.data.error_message,a.data.file_name,a.data.thumbnail,appLocalizer.__current_id,appLocalizer.__compression_type);appLocalizer.__log.show(),appLocalizer.__errors.length>5?jQuery(".compression-bulk-errors-actions").removeClass("wpf-hidden"):appLocalizer.__log.find(".compression-bulk-errors").append(b)}else void 0!==a.success&&a.success&&appLocalizer.__compressed++;if(j(a.data),void 0!==a.data&&"limit_exceeded"===a.data.error&&"resolved"!==appLocalizer.__deferred.state()){let c=document.getElementById("bulk_compression_warning");c.classList.remove("wpf-hidden"),appLocalizer.__button.attr("continue_compression",!1),appLocalizer.uncompressed.unshift(appLocalizer.__current_id),appLocalizer.__ids.unshift(appLocalizer.__current_id),appLocalizer.__perf=performance.now(),g()}else appLocalizer.__is_bulk?q(a):0===appLocalizer.__ids.length&&n();k()}).always(function(){s()&&appLocalizer.__is_bulk?f():appLocalizer.__deferred.resolve()}),appLocalizer.__deferred.errors=appLocalizer.__errors,appLocalizer.__deferred},g=function(){let a=jQuery(".wpfiles-bulk-progress-bar-wrapper");a.addClass("wpfiles-exceed-limit"),a.find(".wpf-progress-block .wpfiles-cancel-bulk").addClass("wpf-hidden"),a.find(".wpf-progress-block .wpfiles-all").removeClass("wpf-hidden"),a.find("i.wpf-icon-loader").addClass("wpf-icon-info").removeClass("wpf-icon-loader").removeClass("wpf-loading"),document.getElementById("bulk-compression-resume-button").classList.remove("wpf-hidden"),document.getElementById("compression-box-bulk-upgrade")&&document.getElementById("compression-box-bulk-upgrade").classList.remove("wpf-hidden")},h=function(a){if(void 0!==appLocalizer.uncompressed&&appLocalizer.uncompressed.length>0){let b=appLocalizer.uncompressed.indexOf(a);b> -1&&appLocalizer.uncompressed.splice(b,1)}if(void 0!==appLocalizer.recompress&&appLocalizer.recompress.length>0){let c=appLocalizer.recompress.indexOf(a);c> -1&&appLocalizer.recompress.splice(c,1)}},i=function(a,b,c,d){let e=jQuery.param({is_bulk_recompress:a,attachment_id:b,_nonce:d});return jQuery.ajax({type:"POST",data:e,url:c,headers:A("POST"),timeout:appLocalizer.timeout,dataType:"json"})},j=function(a){let b=jQuery("#wpfiles-invalid-member");void 0!==a&& void 0!==a.subscription_failed&&b.length>0&&(a.subscription_failed?b.show():b.hide())},k=function(){appLocalizer.__is_bulk||(appLocalizer.__button.html(appLocalizer.wpfiles_msgs.all_done),appLocalizer.__request.done(function(a){if(void 0!==a.data){let b=appLocalizer.__status.parent();j(a.data),a.success?b.html(a.data):(appLocalizer.__status.addClass("error"),appLocalizer.__status.html(a.data.error),appLocalizer.__button.html(window.compression_vars.strings.stats_label)),l(a.data.new_size)}m()}).fail(function(a){appLocalizer.__status.html(a.data),appLocalizer.__status.addClass("error"),m()}))},l=function(a){if(0===a)return;let b=jQuery(".attachment-info .file-size"),c=b.contents().filter(function(){return 3===this.nodeType}).text();if(c!==" "+a){let d=b.contents().filter(function(){return 1===this.nodeType}).text();b.html("<strong>"+d+"</strong> "+a)}},m=function(){appLocalizer.__button.prop("disabled",!1),jQuery(".wpfiles-all").prop("disabled",!1),jQuery("button.wpfiles-scan, a.wpfiles-lossy-enable, button.wpfiles-resize-enable, button#save-settings-button").prop("disabled",!1)},n=function(){let a=jQuery("div.wpfiles-bulk-progress-bar-wrapper div.wpfiles-count.tc"),b=a.html();a.html(appLocalizer.wpfiles_msgs.sync_stats),jQuery.ajax({type:"GET",url:appLocalizer.__url,data:{action:"get_stats"},success(a){a&& void 0!==a&&(a=a.data,jQuery.extend(appLocalizer,{count_images:a.count_images,count_compressed:a.count_compressed,count_total:a.count_total,count_resize:a.count_resize,count_supercompressed:a.count_supercompressed,savings_bytes:a.savings_bytes,savings_conversion:a.savings_conversion,savings_resize:a.savings_resize,size_before:a.size_before,size_after:a.size_after}),o(appLocalizer.__compression_type))}}).always(()=>a.html(b))},o=function(q){let d=0;appLocalizer.savings_bytes=parseInt(appLocalizer.size_before)-parseInt(appLocalizer.size_after);let e=helpers.formatBytes(appLocalizer.savings_bytes,1),m=jQuery(".wpfiles-savings .wpfiles-stats-human");m.html(helpers.getFormatFromString(e)),jQuery(".wpf-summary-large.wpfiles-stats-human").html(helpers.getSizeFromString(e)),appLocalizer.savings_percent=helpers.precise_round(parseInt(appLocalizer.savings_bytes)/parseInt(appLocalizer.size_before)*100,1),isNaN(appLocalizer.savings_percent)||jQuery(".wpfiles-savings .wpfiles-stats-percent").html(appLocalizer.savings_percent),void 0!==appLocalizer.savings_bytes&& void 0!==appLocalizer.savings_resize&&(d=parseInt(appLocalizer.savings_bytes)-parseInt(appLocalizer.savings_resize))>0&&jQuery("li.super-compression-attachments span.compressed-savings").html(helpers.formatBytes(d,1)),jQuery("span.compressed-items-count span.wpfiles-count-total span.wpfiles-total-optimized").html(appLocalizer.count_images),jQuery("span.compressed-items-count span.wpfiles-count-resize-total span.wpfiles-total-optimized").html(appLocalizer.count_resize);let f=jQuery("li.super-compression-attachments .compressed-count");f.length&& void 0!==appLocalizer.count_supercompressed&&f.html(appLocalizer.count_supercompressed);let g=jQuery(".compression-conversion-savings");if(g.length>0&& void 0!==appLocalizer.savings_conversion&&""!==appLocalizer.savings_conversion){let h=g.find(".wpfiles-stats");h.length>0&&h.html(helpers.formatBytes(appLocalizer.savings_conversion,1))}let a=jQuery(".compression-resize-savings");if(a.length>0&& void 0!==appLocalizer.savings_resize&&""!==appLocalizer.savings_resize){let n=parseInt(appLocalizer.savings_resize),i=a.find(".wpfiles-stats"),j=a.find(".wpfiles-stats-label-message");n>0&&i.length>0&&(j.length>0&&j.hide(),i.html(helpers.formatBytes(appLocalizer.savings_resize,1)))}if(x(),void 0!==appLocalizer.pro_savings){let b=jQuery(".compression-avg-pro-savings");if(b.length>0){let k=b.find(".wpfiles-stats-percent"),l=b.find(".wpfiles-stats-human");k.length>0&& void 0!==appLocalizer.pro_savings.percent&&""!==appLocalizer.pro_savings.percent&&k.html(appLocalizer.pro_savings.percent),l.length>0&& void 0!==appLocalizer.pro_savings.savings_bytes&&""!==appLocalizer.pro_savings.savings_bytes&&l.html(appLocalizer.pro_savings.savings_bytes)}}let o=jQuery(".compression-sidenav .wpfiles-remaining-count");if(o.length){let c=0;void 0!==appLocalizer.uncompressed&&appLocalizer.uncompressed.length>0&&(c+=appLocalizer.uncompressed.length),void 0!==appLocalizer.recompress&&appLocalizer.recompress.length>0&&(c+=appLocalizer.recompress.length),p(c)}},p=function(c){let d=jQuery(".wpfiles-remaining-count");d.length&&d.html(c);let a=jQuery(".compression-sidenav .wpfiles-remaining-count"),b=jQuery(".compression-sidenav .compression-bulk .wpf-icon-check-tick");a.length&&b.length&&(c>0?(a.removeClass("wpf-hidden"),b.addClass("wpf-hidden")):(jQuery(".wpf-summary-compression .compression-stats-icon").addClass("wpf-hidden"),b.removeClass("wpf-hidden"),a.addClass("wpf-hidden")))},q=function(a){if(!appLocalizer.__is_bulk_recompress&&!appLocalizer.__is_bulk)return;let b=0;a&& void 0!==a.data&& void 0!==a.data.stats&&w(a.data.stats,appLocalizer.__compression_type),appLocalizer.__is_bulk_recompress?(a.success&&(appLocalizer.recompress.length>0?jQuery(".wpfiles-images-remaining").html(appLocalizer.recompress.length):0===appLocalizer.recompress.length&&0===appLocalizer.__ids.length&&(jQuery(".bulk-recompress-wrapper .wpfiles-all-done, .wpfiles-pagespeed-recommendation").removeClass("wpf-hidden"),jQuery(".wpfiles-recompress-wrap, .wpfiles-bulk-progress-bar-wrapper").addClass("wpf-hidden"))),void 0!==appLocalizer.__ids&& void 0!==appLocalizer.__total&&appLocalizer.__total>0&&(b=(appLocalizer.__compressed+appLocalizer.__errors.length)/appLocalizer.__total*100)):b=(appLocalizer.__compressed+appLocalizer.__errors.length)/appLocalizer.__total*100,0===appLocalizer.__ids.length&&(n(),jQuery(".bulk-compression-wrapper .wpfiles-all-done, .wpfiles-pagespeed-recommendation").removeClass("wpf-hidden"),jQuery(".wpfiles-bulk-wrapper").addClass("wpf-hidden")),void 0!==appLocalizer.__ids&&p(appLocalizer.__ids.length),r(appLocalizer.__compressed+appLocalizer.__errors.length,helpers.precise_round(b,1)),0!==appLocalizer.__ids.length&&o(appLocalizer.__compression_type)},r=function(b,a){(appLocalizer.__is_bulk||appLocalizer.__is_bulk_recompress)&&(jQuery("span.wpfiles-images-percent").html(a+"%"),jQuery(".bulk-compression-wrapper .wpfiles-progress-inner").css("width",a+"%"),jQuery(".bulk-compression-wrapper .wpf-progress-state-text").find("span:first-child").html(b).find("span:last-child").html(appLocalizer.__total))},s=function(){let a=appLocalizer.__button.attr("continue_compression");return void 0===a&&(a=!0),"false"!==a&&a||(a=!1),a&&appLocalizer.__ids.length>0&&appLocalizer.__is_bulk},t=function(){jQuery(".wpfiles-cancel-bulk").on("click",function(){appLocalizer.__button.attr("continue_compression",!1),n(),appLocalizer.__request.abort(),m(),appLocalizer.__button.removeClass("wpfiles-started"),appLocalizer.uncompressed.unshift(appLocalizer.__current_id),jQuery(".wpfiles-bulk-wrapper").removeClass("wpf-hidden"),jQuery(".wpfiles-bulk-progress-bar-wrapper").addClass("wpf-hidden")})},u=function(d,a,c,e,f){let g=void 0===c?'<i class="wpf-icon-photo-picture" aria-hidden="true"></i>':c,h="undefined"===a|| void 0===a?"undefined":a,b='<div class="compression-bulk-error-row"><div class="compression-bulk-image-data">'+g+'<span class="compression-image-name">'+h+'</span><span class="compression-image-error">'+d+"</span></div>";return"media"===f&&(b=b+'<div class="compression-bulk-image-actions"><button type="button" class="wpf-button-icon wpf-tooltip wpf-tooltip-constrained wpf-tooltip-top-right compression-ignore-image" wf-tooltip="'+appLocalizer.wpfiles_msgs.error_ignore+'" data-id="'+e+'"><i class="wpf-icon-eye-hide" aria-hidden="true"></i></button></div>'),b+="</div>"},v=function(){if(!appLocalizer.__is_bulk)return;m();let a=jQuery(".wpf-summary-compression .compression-stats-icon");if(0===appLocalizer.__ids.length)a.addClass("wpf-hidden"),jQuery(".bulk-compression-wrapper .wpfiles-all-done, .wpfiles-pagespeed-recommendation").removeClass("wpf-hidden"),jQuery(".wpfiles-bulk-wrapper").addClass("wpf-hidden"),jQuery(".wpfiles-bulk-progress-bar-wrapper").addClass("wpf-hidden"),document.getElementById("compression-box-bulk-upgrade")&&(document.getElementById("compression-box-bulk-upgrade").classList.remove("wpf-hidden"),document.getElementById("wpfiles-all-compressed-text").classList.remove("wpf-hidden"),document.getElementById("wpfiles-pending-to-compression-text").classList.add("wpf-hidden")),r(0,0);else{a.removeClass("wpf-icon-loader wpf-loading wpf-hidden").addClass("wpf-icon-info wpf-warning");let b=jQuery(".bulk-compression-wrapper .wpfiles-recompress-notice");b.length>0?b.show():jQuery(".bulk-compression-wrapper .wpfiles-remaining").removeClass("wpf-hidden")}jQuery(".wp-recompress.wpfiles-action, .wpfiles-scan").removeProp("disabled")},w=function(a,b){void 0!==window.appLocalizer&&("media"===b?(appLocalizer.count_images=parseInt(appLocalizer.count_images)+parseInt(a.count),a.is_lossy&&(appLocalizer.count_supercompressed=parseInt(appLocalizer.count_supercompressed)+1),appLocalizer.savings_resize=void 0!==a.savings_resize.bytes?parseInt(appLocalizer.savings_resize)+parseInt(a.savings_resize.bytes):parseInt(appLocalizer.savings_resize),appLocalizer.count_resize=void 0!==a.savings_resize.bytes?parseInt(appLocalizer.count_resize)+1:appLocalizer.count_resize,appLocalizer.savings_conversion=void 0!==a.savings_conversion&& void 0!==a.savings_conversion.bytes?parseInt(appLocalizer.savings_conversion)+parseInt(a.savings_conversion.bytes):parseInt(appLocalizer.savings_conversion)):"directory_compression"===b&&(appLocalizer.count_images=parseInt(appLocalizer.count_images)+1),a.size_before>a.size_after&&(appLocalizer.size_before=void 0!==a.size_before?parseInt(appLocalizer.size_before)+parseInt(a.size_before):parseInt(appLocalizer.size_before),appLocalizer.size_after=void 0!==a.size_after?parseInt(appLocalizer.size_after)+parseInt(a.size_after):parseInt(appLocalizer.size_after)),void 0!==a.savings_resize&&(appLocalizer.size_before=void 0!==a.savings_resize.size_before?parseInt(appLocalizer.size_before)+parseInt(a.savings_resize.size_before):parseInt(appLocalizer.size_before),appLocalizer.size_after=void 0!==a.savings_resize.size_after?parseInt(appLocalizer.size_after)+parseInt(a.savings_resize.size_after):parseInt(appLocalizer.size_after)),void 0!==a.savings_conversion&&(appLocalizer.size_before=void 0!==a.savings_conversion.size_before?parseInt(appLocalizer.size_before)+parseInt(a.savings_conversion.size_before):parseInt(appLocalizer.size_before),appLocalizer.size_after=void 0!==a.savings_conversion.size_after?parseInt(appLocalizer.size_after)+parseInt(a.savings_conversion.size_after):parseInt(appLocalizer.size_after)))},x=function(){let a=appLocalizer.savings_percent>0?appLocalizer.savings_percent:0,c=appLocalizer.savings_bytes>0?appLocalizer.savings_bytes:0,b=2.22745683;a>49&&(b=1.22036527),a>0&&(a*=b,c*=b),appLocalizer.pro_savings={percent:helpers.precise_round(a,1),savings_bytes:helpers.formatBytes(c,1)}},y=function(){appLocalizer.__is_bulk&&(jQuery(".wpfiles-bulk-wrapper").addClass("wpf-hidden"),jQuery(".wpf-notice-top").remove(),jQuery(".wpfiles-bulk-progress-bar-wrapper .wpf-notice-warning:first-of-type").hide(),0>=jQuery("div.compression-final-log .compression-bulk-error-row").length&&jQuery("div.compression-final-log").hide(),jQuery(".bulk-compression-wrapper .wpfiles-bulk-progress-bar-wrapper, #wpfiles-running-notice").removeClass("wpf-hidden"))},z=function(){appLocalizer.__deferred.done(function(){if(appLocalizer.__button.removeAttr("continue_compression"),appLocalizer.__errors.length){let a=appLocalizer.wpfiles_msgs.error_in_bulk.replace("{{errors}}",appLocalizer.__errors.length).replace("{{total}}",appLocalizer.__total).replace("{{compressed}}",appLocalizer.__compressed);jQuery(".wpfiles-all-done").addClass("wpf-notice-warning").removeClass("wpf-notice-success").find("p").html(a)}v(),jQuery(".wpfiles-all:not(.wpfiles-finished), .wpfiles-scan").prop("disabled",!1)})},A=function(a){if("POST"==a)return{Accept:"application/json","X-WP-Nonce":appLocalizer.nonce}},B=function(a){if("wp_compressit_manual"==a)return`${appLocalizer.apiUrl}/compression/compress-one`},C=function(b){let a=b.parent();a.css({opacity:"0.5"}),a.find("a").prop("disabled",!0)},D=function(b){let a=b.parent();a.css({opacity:"1"}),a.find("a").prop("disabled",!1)},E=function(d,a,b,e){if(a.prop("disabled"))return;d.preventDefault(),$(".wpfiles-error").remove(),$(".compression-stats-wrapper").hide();let c="grid";"restore-image"===b&&(c=$(document).find("div.media-modal.wp-core-ui").length>0?"grid":window.location.search.indexOf("item")> -1?"grid":"list");let f={action:b,attachment_id:a.data("id"),mode:c,_nonce:a.data("nonce")};C(a),a.html('<span class="spinner wpfiles-progress">'+appLocalizer.wpfiles_msgs[e]+"</span>"),$.ajax({type:"POST",data:f,url:`${appLocalizer.apiUrl}/compression/${b}`,headers:A("POST"),timeout:appLocalizer.timeout,dataType:"json"}).success(b=>{D(a),b.success&& void 0!==b.data?("restore"===e?a.parents().eq(1).html(b.data.stats):a.parents().eq(1).html(b.data),void 0!==b.data&&"restore"===e&&l(b.data.new_size)):b.data&&b.data.error&&("restore"===e?$(".compression-status").addClass("error").html(b.data.error):a.parent().append(b.data.error))})};$("body").on("click",".wpfiles-send:not(.wpfiles-recompress)",function(b){b.preventDefault(),a($(this),!1)}),$("body").on("click",".wpfiles-ignore-image",function(b){b.preventDefault();let a=$(this);a.prop("disabled",!0),a.attr("data-tooltip"),a.removeClass("wpf-tooltip"),$.ajax({type:"POST",data:{action:"ignore_bulk_image",id:a.attr("data-id")},url:`${appLocalizer.apiUrl}/compression/ignore-bulk-image`,headers:A("POST"),timeout:appLocalizer.timeout,dataType:"json"}).done(c=>{a.is("a")&&c.success&& void 0!==c.data.links&&(a.parent().parent().find(".compression-status").text(appLocalizer.wpfiles_msgs.ignored),b.target.closest(".compression-status-links").innerHTML=c.data.links)})}),$("body").on("click",".wpfiles-remove-skipped",function(a){a.preventDefault();let b=$(this);$.ajax({type:"POST",data:{action:"remove_from_skip_list",id:b.attr("data-id")},url:`${appLocalizer.apiUrl}/compression/remove-from-skip-list`,headers:A("POST"),timeout:appLocalizer.timeout,dataType:"json"}).done(c=>{c.success&& void 0!==c.data.links&&(b.parent().parent().find(".compression-status").text(appLocalizer.wpfiles_msgs.not_processed),a.target.closest(".compression-status-links").innerHTML=c.data.links)})}),$("body").on("click",".wpfiles-action.wpfiles-restore",function(a){E(a,$(this),"restore-image","restore")}),$("body").on("click",".wpfiles-action.wpfiles-recompress",function(a){E(a,$(this),"recompress-image","recompress")}),$("body").on("click","a.compression-stats-details",function(b){if($(this).prop("disabled"))return!1;b.preventDefault();let a=$(this).find(".stats-toggle");$(this).parents().eq(1).find(".compression-stats-wrapper").slideToggle(),a.text("+"==a.text()?"-":"+")})})